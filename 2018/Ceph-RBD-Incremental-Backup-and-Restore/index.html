
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="冬日の草原">
    <title>Ceph RDB 的快照、增量备份与恢复 - 冬日の草原</title>
    <meta name="author" content="Yujiang Bi">
    
        <meta name="keywords" content="c++,mac,hexo,linux,python,physics,quantum,machine learning,">
    
    
        <link rel="icon" href="https://amito.me/images/favicon.ico">
    
    
        
            <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Yujiang Bi","sameAs":["https://github.com/byujiang","https://twitter.com/byujiang","https://facebook.com/byujiang","https://www.linkedin.com/profile/","mailto:byujiang@gmail.com"],"image":"bio.jpg"},"articleBody":"Ceph 提供了一些特性和接口, 可以让我们很方便地实现 集群的备份与恢复. 一种是 通过集群镜像, 可以做到实时备份, 但是这个对网络要求比较高,  运行一个镜像集群资源消耗也比较大. 还有一种就是通过 RBD 的快照技术, 实现对 RBD 的数据备份与恢复.\n\n\n\nRBD 的快照功能\n对于快照, 熟悉存储系统和虚拟机的童鞋肯定会有印象. 快照一般是基于时间点或事件对系统做一个标记, 然后在需要的时候, 将状态恢复到标记时的点. 快照的实现前提是底层系统没有损坏…\nNoting that (seeing rbd-backup):\n\n快照 的基本操作\n对于镜像快照的操作, 一般是要指定 pool 名字和 镜像名字. Pool 名字通过 --pool 或者 -p 指定.\n创建快照\n要创建一个快照, 使用 rbd snap create 命令, 基本语法是\n### Usage:\n[ceph@ceph0 ~]$ rbd -p {pool-name} snap create --sanp {snap-name} {image-name}\n### or simply\n[ceph@ceph0 ~]$ rbd snap create {pool-name}/{image-name}@{snap-name}\n### e.g.\n[ceph@ceph0 ~]$ rbd -p rbd snap create --snap foo.2018.09.12.20.30.30 foo\n### or\n[ceph@ceph0 ~]$ rbd snap create rbd/foo@foo.2018.09.12.20.30.30\n\n列出快照\n列出一个镜像的快照, 要指定 Pool 名字和 image 名字.\n### Usage:\n[ceph@ceph0 ~]$ rbd -p {pool-name} snap ls {image-name}\n### or\n[ceph@ceph0]$ rbd snap ls {pool-name}/{image-name}\n### e.g.\n[ceph@ceph0]$ rbd -p rbd snap ls foo\n### or\n[ceph@ceph0]$ rbd snap ls rbd/foo\n\n快照回滚\n使用 rbd snap rollback 对 image 进行回滚操作, 恢复数据,\n### Usage:\n[ceph@ceph0]$ rbd -p {poo-name} snap rollback --snap snap-name {image-name}\n### or\n[ceph@ceph0]$ rbd snap rollback {pool-name}/{image-name}@{snap-name}\n### e.g.\n[ceph@ceph0]$ rbd -p rbd snap rollback --snap snapname foo\n### or\n[ceph@ceph0]$ rbd snap rollback rbd/foo@snapname\n\nCeph 建议使用 快照克隆  功能而不是 回滚操作来还原数据, 因为 随着镜像大小增加, 回滚操作时间会越来越长. 相比之下,  快照克隆 要快很多.\n删除快照\n要删除一个快照, 使用 rbd snap rm 命令.\n### Usage:\n[ceph@ceph0]$ rbd -p {pool-name} snap rm --snap {snap-name} {image-name}\n### or\n[ceph@ceph0]$ rbd snap rm {pool-name}/{image-name}@{snap-name}\n### e.g.\n[ceph@ceph0]$ rbd -p rbd snap rm --snap snapname foo\n### or\n[ceph@ceph0]$ rbd snap rm rbd/foo@snapname\n\nCeph OSDs 删除 快照过程是异步的, 删除一个快照并不能立刻释放空间.\n删除所有快照\n要删除所有快照, 可以使用 rbd snap purge 命令.\n### Usage:\n[ceph@ceph0]$ rbd -p {pool-name} snap purge {image-name}\n### or\n[ceph@ceph0]$ rbd snap purge {pool-name}/{image-name}\n### e.g.\n[ceph@ceph0]$ rbd -p rbd snap purge foo\n### or\n[ceph@ceph0]$ rbd snap purge rbd/foo\n\n快照层次化\nCeph 支持对 rbd 快照创建很多 写时复制(Copy-on-write, COW) 克隆. 快照层次化能够使 Ceph 块设备客户端非常快速地建立镜像. 比如你可以创建一个块设备, 让一个 Linux VM 对其读写； 然后对镜像建立快照, 保护这一快照, 这样你就可以创建任意多的 COW  克隆体.\n \n图中的 parent 表示 Ceph 块设备(parent), 相应的child) 则表示克隆镜像. 这两个术语非常重要.\n每一个克隆镜像(child) 存着一份对 parent 快照的引用, 这使得克隆 image 能够打开 parent 快照读取内容. 一个 COW 的克隆体就像其他正常的块设备 image 一样. 你可以读取, 写入数据, 或者调整大小, 没有什么特别的限制. 然而, COW 克隆 镜像指向 快照, 因此必须要在克隆快照前保护快照. 整个流程如下:\n\n保护快照\n克隆体能够访问 父母快照. 如果 parent 快照被删除了, 所有克隆体都会损坏. 因此为了防止数据丢失, 需要保护要克隆的快照.\n### Usage:\n[ceph@ceph0]$ rbd -p {pool-name} snap protect --image {image-name} --snap {snap-name}\n### or\n[ceph@ceph0]$ rbd snap protect {pool-name}/{image-name}@{snap-name}\n### e.g.\n[ceph@ceph0]$ rbd -p rbd snap protect --image test-image --snap test-image.snap\n### or\n[ceph@ceph0]$ rbd snap protect rbd/test-image@test-image.snap\n\n克隆快照\n这之后就可以对快照进行克隆了.\n### Usage:\n[ceph@ceph0]$ rbd clone -p {pool-name} --image {image-name} --snap {snap-name} --dest-pool {dest-pool-name} --dest {child-image}\n### or\n[ceph@ceph0]$ rbd clone {pool-name}/{parent-image}@{snap-name} {dest-pool-name}/{child-image-name}\n### e.g.\n[ceph@ceph0]$ rbd -p rbd --image test-image --snap test-image.snap --dest-pool dest-rbd --dest dest-test-image\n### or\n[ceph@ceph0]$ rbd clone rbd/test-image@test-image.snap dest-rbd/dest-test-image\n\n列出快照的克隆体\n### Usage:\n[ceph@ceph0]$ rbd -p {pool-name} children --image {image-name} --snap {snap-name}\n### or\n[ceph@ceph0]$ rbd children {pool-name}/{image-name}${snapshot-name}\n### e.g\n[ceph@ceph0]$ rbd -p rbd children --image  test-image --snap test-image.snap\n### or\n[ceph@ceph0]$ rbd children rbd/test-image@test-image.snap\n\n平坦化克隆镜像\n克隆的镜像保持着对 parent 快照的引用, 移除 child 克隆体对 parent 快照的引用实际上就是通过从快照拷贝信息到克隆体来将这个镜像 平坦化(flattening).\n### Usage:\n[ceph@ceph0]$ rbd -p {pool-name} flatten --image {image-name}\n### or\n[ceph@ceph0]$ rbd flatten {pool-name}/{image-name}\n### e.g.\n[ceph@ceph0]$ rbd -p dest-rbd --image dest-test-image\n### or\n[ceph@ceph0]$ rbd flatten dest-rbd/dest-test-image\n\n一个 flattened 的 image 占据的存储空间要比 layered 克隆体大.\n取消对快照的保护\n在删除一个受保护的快照时, 需要先取消对快照的保护.  除此之外, 你还需要将与之有引用关系的克隆体平坦化(flatten), 再删除快照.\n[ceph@ceph0]$ rbd -p {pool-name} snap unprotect --image {image-name} --snap {snapshot-name}\n### or\n[ceph@ceph0]$ rbd snap unprotect {pool-name}/{image-name}@{snapshot-name}\n\n基于快照的增量备份\n在了解了 Ceph RBD 的快照功能后, 我们就可以来看看如何通过快照来对 RBD image 进行备份. 过程也非常简单.\n快照的创建和导出\n\n我们先建一个测试 pool 和 image:\n\n[ceph@ceph0 ~]$ rbd mkpool test_pool\n[ceph@ceph0 ~]$ rbd create test_pool/test_image --size 200 --image-format 2 --order 24\n[ceph@ceph0 ~]$ do_some_work\n\n\n在时间节点 t1 和 t2 分别创建快照:\n\n[ceph@ceph0 ~]$ rbd snap create test_pool/test_image@test.snap.t1\n[ceph@ceph0 ~]$ do_some_work\n[ceph@ceph0 ~]$ rbd snap create test_pool/test_image@test.snap.t2\n\n\n导出 v1 与 v2\n\n## rbd export-diff --pool {pool name} --image {image name} --snap {snap name} {exported file name}\n## or\n## rbd export-diff {pool name}/{image name}@{snap name} {exported file name}\n[ceph@ceph0 ~]$ rbd export-diff test_pool/test_image@test.snap.t1 test_image_test.snap.t1\n[ceph@ceph0 ~]$ rbd export-diff test_pool/test_image@test.snap.t2 test_image_test.snap.t2\n\nFull export.\n\n导出 v1 与 v2 的差异数据\n\n## rbd export-diff --from-snap snap1 --pool {pool name} --image {image name} --snap {snap name} {exported file name}\n## or\n### rbd export-diff --from-snap snap1 {pool_name}/{image_name}@{snap-name} exported_file_name\n### diff from t1 to t2\n[ceph@ceph0]$ rbd export-diff --from-snap test.snap.t1 test_pool/test_image@test.snap.t2 test_pool_test_image_snap.t1_to_snap.t2.diff\n### diff from initial to t1\n[ceph@ceph0]$ rbd export-diff test_pool/test_image@test_snap.t1 test_snap_t1\n### diff from initial to t2\n[ceph@ceph0]$ rbd export-diff test_pool/test_image@test_snap.t2 test_snap_t2\n\n导出之后, 就可以将 diff 文件传送 到备份服务器上保存起来.\n你可以查看有哪些内容被修改了:\n[ceph@ceph0]$ rbd diff --from-snap test.snap.t1 test_pool/test_image@test.snap.t2 --format plain\n\n\n导出快照时，可以使用 **–rbd-concurrent-management-ops** 来 并行化  进行:\n\n$ rbd export --rbd-concurrent-management-ops 20 --pool=test_pool test_image@test.snap.t2\n\n快照的导入与数据恢复\n为了简单, 我们在 test-pool 下新建一个 image, 再导入 diff 文件:\n[ceph@ceph0 ~]$ rbd create test-pool/backup_image --size 1 --image-format 2 --order 24\n### import diff from initial to t1\n[ceph@ceph0 ~]$ rbd import-diff test_snap_t1 test_pool/backup_image\n### import diff from t1 to t2\n[ceph@ceph0 ~]$ rbd import-diff test_pool_test_image_snap.t1_to_snap.t2.diff test_pool/backup_image\n### or import diff from initial to t2\n[ceph@ceph0 ~]$ rbd import-diff test_snap_t2 test_pool/backup_image\n\n这样就可以恢复数据了.\n要是运行着两个 Ceph 集群来预防灾难并在灾难后做数据恢复, 可以在线的方式对其做快照备份:\n[ceph@ceph0]$ rbd export-diff --from-snap test.snap.t1 test_pool/test_image@snap.t2 - | ssh user@second_cluster rbd import-diff - test_pool/test_image\n\n如果想要使用快照覆盖原 image 来恢复数据，可以使用前面提到的 rollback：\n[ceph@ceph0]$ rbd snap rollback rbd/foo@snapname\n\n备份整个 RBD Pool\n上面是对一个 image 的备份和还原, 在实际中, 会有非常多的 image 需要备份. 有了上面的例子, 我们可以很容易地写一个脚本来定时备份 RBD pool.\nBackup tool:\n\nbacky2\nrbd-backup\nceph-backup\nceph-rbd-backup\nceph-vm-backup\n\n\n        document.querySelectorAll('.github-emoji')\n          .forEach(el => {\n            if (!el.dataset.src) { return; }\n            const img = document.createElement('img');\n            img.style = 'display:none !important;';\n            img.src = el.dataset.src;\n            img.addEventListener('error', () => {\n              img.remove();\n              el.style.color = 'inherit';\n              el.style.backgroundImage = 'none';\n              el.style.background = 'none';\n            });\n            img.addEventListener('load', () => {\n              img.remove();\n            });\n            document.body.appendChild(img);\n          });\n      ","dateCreated":"2018-09-06T16:54:26+08:00","dateModified":"2020-04-14T12:05:28+08:00","datePublished":"2018-09-06T16:54:26+08:00","description":"Ceph 提供了一些特性和接口, 可以让我们很方便地实现 集群的备份与恢复. 一种是 通过集群镜像,可以做到实时备份, 但是这个对网络要求比较高,  运行一个镜像集群资源消耗也比较大. 还有一种就是通过 RBD 的快照技术, 实现对 RBD 的数据备份与恢复.","headline":"Ceph RDB 的快照、增量备份与恢复","image":["ceph.png"],"mainEntityOfPage":{"@type":"WebPage","@id":"https://amito.me/2018/Ceph-RBD-Incremental-Backup-and-Restore/"},"publisher":{"@type":"Organization","name":"Yujiang Bi","sameAs":["https://github.com/byujiang","https://twitter.com/byujiang","https://facebook.com/byujiang","https://www.linkedin.com/profile/","mailto:byujiang@gmail.com"],"image":"bio.jpg","logo":{"@type":"ImageObject","url":"bio.jpg"}},"url":"https://amito.me/2018/Ceph-RBD-Incremental-Backup-and-Restore/","keywords":"Ceph, Rados","thumbnailUrl":"ceph.png"}</script>
    <meta name="description" content="Ceph 提供了一些特性和接口, 可以让我们很方便地实现 集群的备份与恢复. 一种是 通过集群镜像,可以做到实时备份, 但是这个对网络要求比较高,  运行一个镜像集群资源消耗也比较大. 还有一种就是通过 RBD 的快照技术, 实现对 RBD 的数据备份与恢复.">
<meta name="keywords" content="Ceph,Rados">
<meta property="og:type" content="blog">
<meta property="og:title" content="Ceph RDB 的快照、增量备份与恢复">
<meta property="og:url" content="https://amito.me/2018/Ceph-RBD-Incremental-Backup-and-Restore/index.html">
<meta property="og:site_name" content="冬日の草原">
<meta property="og:description" content="Ceph 提供了一些特性和接口, 可以让我们很方便地实现 集群的备份与恢复. 一种是 通过集群镜像,可以做到实时备份, 但是这个对网络要求比较高,  运行一个镜像集群资源消耗也比较大. 还有一种就是通过 RBD 的快照技术, 实现对 RBD 的数据备份与恢复.">
<meta property="og:locale" content="zh-cn">
<meta property="og:image" content="https://amito.me/2018/Ceph-RBD-Incremental-Backup-and-Restore/warning.png">
<meta property="og:image" content="https://amito.me/2018/Ceph-RBD-Incremental-Backup-and-Restore/ceph-rbd-snap-clone.png">
<meta property="og:image" content="https://amito.me/2018/Ceph-RBD-Incremental-Backup-and-Restore/ceph-rbd-layer.png">
<meta property="og:updated_time" content="2020-04-14T04:05:28.332Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ceph RDB 的快照、增量备份与恢复">
<meta name="twitter:description" content="Ceph 提供了一些特性和接口, 可以让我们很方便地实现 集群的备份与恢复. 一种是 通过集群镜像,可以做到实时备份, 但是这个对网络要求比较高,  运行一个镜像集群资源消耗也比较大. 还有一种就是通过 RBD 的快照技术, 实现对 RBD 的数据备份与恢复.">
<meta name="twitter:image" content="https://amito.me/2018/Ceph-RBD-Incremental-Backup-and-Restore/warning.png">
<meta name="twitter:creator" content="@byujiang">
    
    
        
            <meta property="fb:admins" content="892874147463767"/>
        
    
    
        <meta property="og:image" content="https://amito.me/images/bio.jpg"/>
    
    
        <meta property="og:image" content="https://amito.me/2018/Ceph-RBD-Incremental-Backup-and-Restore/ceph.png"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://amito.me/2018/Ceph-RBD-Incremental-Backup-and-Restore/ceph.png"/>
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-tezmfre0lh5rmg4t8dwwir4ug0e4vfxbyvizyx3l9dl4t2xeazqzekpcj3jq.min.css">
    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-46872566-3"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-46872566-3');
    </script>


    
    
	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({
			google_ad_client: "ca-pub-9943170083368654",
			enable_page_level_ads: true
		});
	</script>



    
        
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

    <body>
        <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="2">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/ "
            aria-label=""
        >
            冬日の草原
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="打开链接: /#about"
            >
        
        
            <img class="header-picture" src="/images/bio.jpg" alt="作者的图片"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="2">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="阅读有关作者的更多信息"
                >
                    <img class="sidebar-profile-picture" src="/images/bio.jpg" alt="作者的图片"/>
                </a>
                <h4 class="sidebar-profile-name">Yujiang Bi</h4>
                
                    <h5 class="sidebar-profile-bio"><p>What dosn’t kill makes you stranger</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="首页"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首页</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="分类"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分类</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="标签"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">标签</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="归档"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">归档</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="搜索"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">搜索</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="关于"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">关于</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/byujiang"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://twitter.com/byujiang"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Twitter"
                        >
                        <i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://facebook.com/byujiang"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Facebook"
                        >
                        <i class="sidebar-button-icon fab fa-facebook" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Facebook</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.linkedin.com/profile/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="LinkedIn"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="mailto:byujiang@gmail.com"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="邮箱"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">邮箱</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/donate"
                            
                            rel="noopener"
                            title="donate"
                        >
                        <i class="sidebar-button-icon fa fa-heart" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">donate</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/links"
                            
                            rel="noopener"
                            title="links"
                        >
                        <i class="sidebar-button-icon fa fa-link" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">links</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.vultr.com/?ref=6840862"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="vultr"
                        >
                        <i class="sidebar-button-icon fa fa-cloud" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">vultr</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="2"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            Ceph RDB 的快照、增量备份与恢复
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2018-09-06T16:54:26+08:00">
	
		    9月 06, 2018
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/Ceph/">Ceph</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>Ceph 提供了一些特性和接口, 可以让我们很方便地实现 集群的备份与恢复. 一种是 通过集群镜像, 可以做到实时备份, 但是这个对网络要求比较高,  运行一个镜像集群资源消耗也比较大. 还有一种就是通过 <code>RBD</code> 的快照技术, 实现对 <code>RBD</code> 的数据备份与恢复.</p>
<a id="more"></a>
<hr width="100%" color="#C0C0C0" size="2">
<h1 id="table-of-contents">目录</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#RBD- 的快照功能"><span class="toc-text">RBD 的快照功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#快照 - 的基本操作"><span class="toc-text">快照 的基本操作</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建快照"><span class="toc-text">创建快照</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#列出快照"><span class="toc-text">列出快照</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#快照回滚"><span class="toc-text">快照回滚</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#删除快照"><span class="toc-text">删除快照</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#删除所有快照"><span class="toc-text">删除所有快照</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#快照层次化"><span class="toc-text">快照层次化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#保护快照"><span class="toc-text">保护快照</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#克隆快照"><span class="toc-text">克隆快照</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#列出快照的克隆体"><span class="toc-text">列出快照的克隆体</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#平坦化克隆镜像"><span class="toc-text">平坦化克隆镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#取消对快照的保护"><span class="toc-text">取消对快照的保护</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基于快照的增量备份"><span class="toc-text">基于快照的增量备份</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#快照的创建和导出"><span class="toc-text">快照的创建和导出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#快照的导入与数据恢复"><span class="toc-text">快照的导入与数据恢复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#备份整个 -RBD-Pool"><span class="toc-text">备份整个 RBD Pool</span></a></li></ol></li></ol>
<h2 id="RBD- 的快照功能">RBD 的快照功能</h2>
<p>对于快照, 熟悉存储系统和虚拟机的童鞋肯定会有印象. 快照一般是基于时间点或事件对系统做一个标记, 然后在需要的时候, 将状态恢复到标记时的点. 快照的实现前提是底层系统没有损坏…</p>
<p>Noting that (seeing <a href="https://docs.ceph.com/docs/master/rbd/rbd-snapshot/" target="_blank" rel="noopener">rbd-backup</a>):</p>
<div class="figure" style="width:;"><img class="fig-img" src="warning.png" alt=""></div>
<h3 id="快照 - 的基本操作">快照 的基本操作</h3>
<p>对于镜像快照的操作, 一般是要指定 pool 名字和 镜像名字. Pool 名字通过 <code>--pool</code> 或者 <code>-p</code> 指定.</p>
<h4 id="创建快照">创建快照</h4>
<p>要创建一个快照, 使用 <code>rbd snap create</code> 命令, 基本语法是</p>
<pre class=" language-language-bash"><code class="language-language-bash">### Usage:
[ceph@ceph0 ~]$ rbd -p {pool-name} snap create --sanp {snap-name} {image-name}
### or simply
[ceph@ceph0 ~]$ rbd snap create {pool-name}/{image-name}@{snap-name}
### e.g.
[ceph@ceph0 ~]$ rbd -p rbd snap create --snap foo.2018.09.12.20.30.30 foo
### or
[ceph@ceph0 ~]$ rbd snap create rbd/foo@foo.2018.09.12.20.30.30
</code></pre>
<h4 id="列出快照">列出快照</h4>
<p>列出一个镜像的快照, 要指定 Pool 名字和 image 名字.</p>
<pre class=" language-language-bash"><code class="language-language-bash">### Usage:
[ceph@ceph0 ~]$ rbd -p {pool-name} snap ls {image-name}
### or
[ceph@ceph0]$ rbd snap ls {pool-name}/{image-name}
### e.g.
[ceph@ceph0]$ rbd -p rbd snap ls foo
### or
[ceph@ceph0]$ rbd snap ls rbd/foo
</code></pre>
<h4 id="快照回滚">快照回滚</h4>
<p>使用 <code>rbd snap rollback</code> 对 image 进行回滚操作, 恢复数据,</p>
<pre class=" language-language-bash"><code class="language-language-bash">### Usage:
[ceph@ceph0]$ rbd -p {poo-name} snap rollback --snap snap-name {image-name}
### or
[ceph@ceph0]$ rbd snap rollback {pool-name}/{image-name}@{snap-name}
### e.g.
[ceph@ceph0]$ rbd -p rbd snap rollback --snap snapname foo
### or
[ceph@ceph0]$ rbd snap rollback rbd/foo@snapname
</code></pre>
<p>Ceph 建议使用 <code>快照克隆 </code> 功能而不是 回滚操作来还原数据, 因为 随着镜像大小增加, 回滚操作时间会越来越长. 相比之下, <code> 快照克隆</code> 要快很多.</p>
<h4 id="删除快照">删除快照</h4>
<p>要删除一个快照, 使用 <code>rbd snap rm</code> 命令.</p>
<pre class=" language-language-bash"><code class="language-language-bash">### Usage:
[ceph@ceph0]$ rbd -p {pool-name} snap rm --snap {snap-name} {image-name}
### or
[ceph@ceph0]$ rbd snap rm {pool-name}/{image-name}@{snap-name}
### e.g.
[ceph@ceph0]$ rbd -p rbd snap rm --snap snapname foo
### or
[ceph@ceph0]$ rbd snap rm rbd/foo@snapname
</code></pre>
<p>Ceph OSDs 删除 快照过程是异步的, 删除一个快照并不能立刻释放空间.</p>
<h4 id="删除所有快照">删除所有快照</h4>
<p>要删除所有快照, 可以使用 <code>rbd snap purge</code> 命令.</p>
<pre class=" language-language-bash"><code class="language-language-bash">### Usage:
[ceph@ceph0]$ rbd -p {pool-name} snap purge {image-name}
### or
[ceph@ceph0]$ rbd snap purge {pool-name}/{image-name}
### e.g.
[ceph@ceph0]$ rbd -p rbd snap purge foo
### or
[ceph@ceph0]$ rbd snap purge rbd/foo
</code></pre>
<h3 id="快照层次化">快照层次化</h3>
<p>Ceph 支持对 rbd 快照创建很多 写时复制(Copy-on-write, COW) 克隆. 快照层次化能够使 Ceph 块设备客户端非常快速地建立镜像. 比如你可以创建一个块设备, 让一个 Linux VM 对其读写； 然后对镜像建立快照, 保护这一快照, 这样你就可以创建任意多的 COW  克隆体.</p>
 <div class="figure center" style="width:800px;"><img class="fig-img" src="ceph-rbd-snap-clone.png" style="width:800px;" alt=""></div>
<p>图中的 <code>parent</code> 表示 Ceph 块设备(parent), 相应的<code>child)</code> 则表示克隆镜像. 这两个术语非常重要.</p>
<p>每一个克隆镜像(child) 存着一份对 parent 快照的引用, 这使得克隆 image 能够打开 parent 快照读取内容. 一个 COW 的克隆体就像其他正常的块设备 image 一样. 你可以读取, 写入数据, 或者调整大小, 没有什么特别的限制. 然而, COW 克隆 镜像指向 快照, 因此必须要在克隆快照前保护快照. 整个流程如下:</p>
<div class="figure center" style="width:800px;"><img class="fig-img" src="ceph-rbd-layer.png" style="width:800px;" alt=""></div>
<h4 id="保护快照">保护快照</h4>
<p>克隆体能够访问 父母快照. 如果 parent 快照被删除了, 所有克隆体都会损坏. 因此为了防止数据丢失, 需要保护要克隆的快照.</p>
<pre class=" language-language-bash"><code class="language-language-bash">### Usage:
[ceph@ceph0]$ rbd -p {pool-name} snap protect --image {image-name} --snap {snap-name}
### or
[ceph@ceph0]$ rbd snap protect {pool-name}/{image-name}@{snap-name}
### e.g.
[ceph@ceph0]$ rbd -p rbd snap protect --image test-image --snap test-image.snap
### or
[ceph@ceph0]$ rbd snap protect rbd/test-image@test-image.snap
</code></pre>
<h3 id="克隆快照">克隆快照</h3>
<p>这之后就可以对快照进行克隆了.</p>
<pre class=" language-language-bash"><code class="language-language-bash">### Usage:
[ceph@ceph0]$ rbd clone -p {pool-name} --image {image-name} --snap {snap-name} --dest-pool {dest-pool-name} --dest {child-image}
### or
[ceph@ceph0]$ rbd clone {pool-name}/{parent-image}@{snap-name} {dest-pool-name}/{child-image-name}
### e.g.
[ceph@ceph0]$ rbd -p rbd --image test-image --snap test-image.snap --dest-pool dest-rbd --dest dest-test-image
### or
[ceph@ceph0]$ rbd clone rbd/test-image@test-image.snap dest-rbd/dest-test-image
</code></pre>
<h4 id="列出快照的克隆体">列出快照的克隆体</h4>
<pre class=" language-language-bash"><code class="language-language-bash">### Usage:
[ceph@ceph0]$ rbd -p {pool-name} children --image {image-name} --snap {snap-name}
### or
[ceph@ceph0]$ rbd children {pool-name}/{image-name}${snapshot-name}
### e.g
[ceph@ceph0]$ rbd -p rbd children --image  test-image --snap test-image.snap
### or
[ceph@ceph0]$ rbd children rbd/test-image@test-image.snap
</code></pre>
<h4 id="平坦化克隆镜像">平坦化克隆镜像</h4>
<p>克隆的镜像保持着对 parent 快照的引用, 移除 child 克隆体对 parent 快照的引用实际上就是通过从快照拷贝信息到克隆体来将这个镜像 <code>平坦化(flattening)</code>.</p>
<pre class=" language-language-bash"><code class="language-language-bash">### Usage:
[ceph@ceph0]$ rbd -p {pool-name} flatten --image {image-name}
### or
[ceph@ceph0]$ rbd flatten {pool-name}/{image-name}
### e.g.
[ceph@ceph0]$ rbd -p dest-rbd --image dest-test-image
### or
[ceph@ceph0]$ rbd flatten dest-rbd/dest-test-image
</code></pre>
<p>一个 <code>flattened</code> 的 image 占据的存储空间要比 <code>layered</code> 克隆体大.</p>
<h4 id="取消对快照的保护">取消对快照的保护</h4>
<p>在删除一个受保护的快照时, 需要先取消对快照的保护.  除此之外, 你还需要将与之有引用关系的克隆体平坦化(flatten), 再删除快照.</p>
<pre class=" language-language-bash"><code class="language-language-bash">[ceph@ceph0]$ rbd -p {pool-name} snap unprotect --image {image-name} --snap {snapshot-name}
### or
[ceph@ceph0]$ rbd snap unprotect {pool-name}/{image-name}@{snapshot-name}
</code></pre>
<h2 id="基于快照的增量备份">基于快照的增量备份</h2>
<p>在了解了 Ceph RBD 的快照功能后, 我们就可以来看看如何通过快照来对 RBD image 进行备份. 过程也非常简单.</p>
<h3 id="快照的创建和导出">快照的创建和导出</h3>
<ol>
<li>我们先建一个测试 pool 和 image:</li>
</ol>
<pre class=" language-language-bash"><code class="language-language-bash">[ceph@ceph0 ~]$ rbd mkpool test_pool
[ceph@ceph0 ~]$ rbd create test_pool/test_image --size 200 --image-format 2 --order 24
[ceph@ceph0 ~]$ do_some_work
</code></pre>
<ol start="2">
<li>在时间节点 <code>t1</code> 和 <code>t2</code> 分别创建快照:</li>
</ol>
<pre class=" language-language-bash"><code class="language-language-bash">[ceph@ceph0 ~]$ rbd snap create test_pool/test_image@test.snap.t1
[ceph@ceph0 ~]$ do_some_work
[ceph@ceph0 ~]$ rbd snap create test_pool/test_image@test.snap.t2
</code></pre>
<ol start="3">
<li>导出 <code>v1</code> 与 <code>v2</code></li>
</ol>
<pre class=" language-language-bash"><code class="language-language-bash">## rbd export-diff --pool {pool name} --image {image name} --snap {snap name} {exported file name}
## or
## rbd export-diff {pool name}/{image name}@{snap name} {exported file name}
[ceph@ceph0 ~]$ rbd export-diff test_pool/test_image@test.snap.t1 test_image_test.snap.t1
[ceph@ceph0 ~]$ rbd export-diff test_pool/test_image@test.snap.t2 test_image_test.snap.t2
</code></pre>
<p>Full export.</p>
<ol start="4">
<li>导出 <code>v1</code> 与 <code>v2</code> 的差异数据</li>
</ol>
<pre class=" language-language-bash"><code class="language-language-bash">## rbd export-diff --from-snap snap1 --pool {pool name} --image {image name} --snap {snap name} {exported file name}
## or
### rbd export-diff --from-snap snap1 {pool_name}/{image_name}@{snap-name} exported_file_name
### diff from t1 to t2
[ceph@ceph0]$ rbd export-diff --from-snap test.snap.t1 test_pool/test_image@test.snap.t2 test_pool_test_image_snap.t1_to_snap.t2.diff
### diff from initial to t1
[ceph@ceph0]$ rbd export-diff test_pool/test_image@test_snap.t1 test_snap_t1
### diff from initial to t2
[ceph@ceph0]$ rbd export-diff test_pool/test_image@test_snap.t2 test_snap_t2
</code></pre>
<p>导出之后, 就可以将 diff 文件传送 到备份服务器上保存起来.</p>
<p>你可以查看有哪些内容被修改了:</p>
<pre class=" language-language-bash"><code class="language-language-bash">[ceph@ceph0]$ rbd diff --from-snap test.snap.t1 test_pool/test_image@test.snap.t2 --format plain
</code></pre>
<ol start="5">
<li>导出快照时，可以使用 **–rbd-concurrent-management-ops** 来 <strong>并行化 </strong> 进行:</li>
</ol>
<pre class=" language-language-bash"><code class="language-language-bash">$ rbd export --rbd-concurrent-management-ops 20 --pool=test_pool test_image@test.snap.t2
</code></pre>
<h3 id="快照的导入与数据恢复">快照的导入与数据恢复</h3>
<p>为了简单, 我们在 <code>test-pool</code> 下新建一个 image, 再导入 diff 文件:</p>
<pre class=" language-language-bash"><code class="language-language-bash">[ceph@ceph0 ~]$ rbd create test-pool/backup_image --size 1 --image-format 2 --order 24
### import diff from initial to t1
[ceph@ceph0 ~]$ rbd import-diff test_snap_t1 test_pool/backup_image
### import diff from t1 to t2
[ceph@ceph0 ~]$ rbd import-diff test_pool_test_image_snap.t1_to_snap.t2.diff test_pool/backup_image
### or import diff from initial to t2
[ceph@ceph0 ~]$ rbd import-diff test_snap_t2 test_pool/backup_image
</code></pre>
<p>这样就可以恢复数据了.</p>
<p>要是运行着两个 Ceph 集群来预防灾难并在灾难后做数据恢复, 可以在线的方式对其做快照备份:</p>
<pre class=" language-language-bash"><code class="language-language-bash">[ceph@ceph0]$ rbd export-diff --from-snap test.snap.t1 test_pool/test_image@snap.t2 - | ssh user@second_cluster rbd import-diff - test_pool/test_image
</code></pre>
<p>如果想要使用快照覆盖原 image 来恢复数据，可以使用前面提到的 <code>rollback</code>：</p>
<pre class=" language-language-bash"><code class="language-language-bash">[ceph@ceph0]$ rbd snap rollback rbd/foo@snapname
</code></pre>
<h3 id="备份整个 -RBD-Pool">备份整个 RBD Pool</h3>
<p>上面是对一个 image 的备份和还原, 在实际中, 会有非常多的 image 需要备份. 有了上面的例子, 我们可以很容易地写一个脚本来定时备份 RBD pool.</p>
<p>Backup tool:</p>
<ul>
<li><a href="http://backy2.com/" target="_blank" rel="noopener">backy2</a></li>
<li><a href="https://github.com/magusnebula/ceph_backup_script" target="_blank" rel="noopener">rbd-backup</a></li>
<li><a href="https://github.com/teralytics/ceph-backup" target="_blank" rel="noopener">ceph-backup</a></li>
<li><a href="https://github.com/camptocamp/ceph-rbd-backup" target="_blank" rel="noopener">ceph-rbd-backup</a></li>
<li><a href="https://www.wogri.at/scripts/ceph-vm-backup/" target="_blank" rel="noopener">ceph-vm-backup</a></li>
</ul>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            


            <div class="post_reward" style="margin-top:15px;margin-bottom:0px;">
	<label class="reward_btn">Buy Me A Coffee?</label>
	<div class="qr_code">
		<div class="qr_code_img">
			<img class="image" src="/images/wechat.png" style="width:80%;" title="WeChat">
		</div>
		<div class="qr_code_img">
			<img class="image" src="/images/alipay.png" style="width:80%;" title="AliPay">
		</div>
		<div class="qr_code_img">
			<img class="image" src="/images/paypal.png" style="width:80%;" title="PayPal">
		</div>
	</div>
	<hr noshade style="color:rgba(252, 244, 244, 0.952); margin-top:10px;" />
</div>

        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">标签</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/Ceph/">Ceph</a> <a class="tag tag--primary tag--small t-link" href="/tags/Rados/">Rados</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2018/Ceph-Data-Disaster-Recovery/"
                    data-tooltip="Ceph 中的数据灾难重建"
                    aria-label="上一篇: Ceph 中的数据灾难重建"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2018/Monitor-File-Change-under-Linux/"
                    data-tooltip="在 Linux 下监控程序修改文件"
                    aria-label="下一篇: 在 Linux 下监控程序修改文件"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Diesen Beitrag teilen"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://amito.me/2018/Ceph-RBD-Incremental-Backup-and-Restore/"
                    title="分享到 Facebook"
                    aria-label="分享到 Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://amito.me/2018/Ceph-RBD-Incremental-Backup-and-Restore/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://amito.me/2018/Ceph-RBD-Incremental-Backup-and-Restore/"
                    title="global.share_on_linkedin"
                    aria-label="global.share_on_linkedin"
                >
                    <i class="fab fa-linkedin" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://service.weibo.com/share/share.php?&amp;title=https://amito.me/2018/Ceph-RBD-Incremental-Backup-and-Restore/"
                    title="分享到 Weibo"
                    aria-label="分享到 Weibo"
                >
                    <i class="fab fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a
                        class="post-action-btn btn btn--default"
                        href="#disqus_thread"
                        aria-label="Kommentieren"
                    >
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#table-of-contents" aria-label="目录">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
                <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2020 Yujiang Bi. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="2">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2018/Ceph-Data-Disaster-Recovery/"
                    data-tooltip="Ceph 中的数据灾难重建"
                    aria-label="上一篇: Ceph 中的数据灾难重建"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2018/Monitor-File-Change-under-Linux/"
                    data-tooltip="在 Linux 下监控程序修改文件"
                    aria-label="下一篇: 在 Linux 下监控程序修改文件"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Diesen Beitrag teilen"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://amito.me/2018/Ceph-RBD-Incremental-Backup-and-Restore/"
                    title="分享到 Facebook"
                    aria-label="分享到 Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://amito.me/2018/Ceph-RBD-Incremental-Backup-and-Restore/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://amito.me/2018/Ceph-RBD-Incremental-Backup-and-Restore/"
                    title="global.share_on_linkedin"
                    aria-label="global.share_on_linkedin"
                >
                    <i class="fab fa-linkedin" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://service.weibo.com/share/share.php?&amp;title=https://amito.me/2018/Ceph-RBD-Incremental-Backup-and-Restore/"
                    title="分享到 Weibo"
                    aria-label="分享到 Weibo"
                >
                    <i class="fab fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a
                        class="post-action-btn btn btn--default"
                        href="#disqus_thread"
                        aria-label="Kommentieren"
                    >
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#table-of-contents" aria-label="目录">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="2">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://amito.me/2018/Ceph-RBD-Incremental-Backup-and-Restore/"
                        aria-label="分享到 Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>分享到 Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://amito.me/2018/Ceph-RBD-Incremental-Backup-and-Restore/"
                        aria-label="分享到 Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>分享到 Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://amito.me/2018/Ceph-RBD-Incremental-Backup-and-Restore/"
                        aria-label="global.share_on_linkedin"
                    >
                        <i class="fab fa-linkedin" aria-hidden="true"></i><span>global.share_on_linkedin</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://service.weibo.com/share/share.php?&amp;title=https://amito.me/2018/Ceph-RBD-Incremental-Backup-and-Restore/"
                        aria-label="分享到 Weibo"
                    >
                        <i class="fab fa-weibo" aria-hidden="true"></i><span>分享到 Weibo</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/images/bio.jpg" alt="作者的图片"/>
        
            <h4 id="about-card-name">Yujiang Bi</h4>
        
            <div id="about-card-bio"><p>What dosn’t kill makes you stranger</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>Research Assistant</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Beijing, China
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-ujpvsmhzrh5mqwagjks2e24jraq0wtxyz3ic6elzhd7ladpzxaohyd0cqohy.min.js"></script>
<!--SCRIPTS END-->


    
        <script>
          var disqus_config = function() {
            this.page.url = 'https://amito.me/2018/Ceph-RBD-Incremental-Backup-and-Restore/';
              
            this.page.identifier = '2018/Ceph-RBD-Incremental-Backup-and-Restore/';
              
          };
          (function() {
            var d = document, s = d.createElement('script');
            var disqus_shortname = 'amito';
            s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
          })();
        </script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
    




    </body>
</html>
