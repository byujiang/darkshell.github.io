
<!DOCTYPE html>
<html lang="zh-cn">
    
<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="冬日の草原">
    <title>部署并运行 Redis 数据库集群 - 冬日の草原</title>
    <meta name="author" content="Yujiang Bi">
    
        <meta name="keywords" content="c++,mac,hexo,linux,python,physics,quantum,machine learning,">
    
    
        <link rel="icon" href="https://amito.me/images/favicon.ico">
    
    
        
            <link rel="alternate" type="application/atom+xml" title="RSS" href="/atom.xml">
        
    
    <script type="application/ld+json">{"@context":"http://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Yujiang Bi","sameAs":["https://github.com/byujiang","https://twitter.com/byujiang","https://facebook.com/byujiang","https://www.linkedin.com/profile/","mailto:byujiang@gmail.com"],"image":"bio.jpg"},"articleBody":"Redis 是一个开源的、轻量级的、高性能的、基于  键 - 值  对的缓存与存储系统，非常适合用来缓存和存储服务和消息队列、任务队列等。\n\n\n\n\n 安装 Redis\n 目前最新的稳定版是 5.0.0. CentOS 7 的源中最新版为 3.2.12. 如果不需要新特性, 可以使用官方的版本. 这里我们使用 5.0.0 版本.\n$ wget http://download.redis.io/releases/redis-5.0.0.tar.gz\n$ tar xf redis-5.0.0.tar.gz\n$ cd redis-5.0.0 && make -j4\n$ make test && sudo make install\n\nRedist 集群介绍 \nRedis 集群简介 \nRedis 集群所用 TCP 端口 \n 每一 Redis 集群节点都要两个 TCP 连接。 一个 TCP 端口为数据端口，用于服务客户端， 默认为 6379， 一个为 数据端口 +10000, 用于集群节点间的通信，默认就是 16379， 增量 10000 是固定的。\n 第二个端口是专门用来节点间通信的集群总结 (Cluster bus)，使用一个二进制协议。 Cluster bus 被用来作错误检测，配置更新，故障转移论证等等， 因此客户端应该永远不要使用这一端口，而是使用正常的数据端口。\n 如果开了防火墙， 需要在防火墙中打开这两个端口， 否则 Redis 集群无法正常工作。\nRedis 集群的主－从模型 \n 部署 Redis 集群 \n 要部署 Redis 集群, 我们需要先有已经运行的 Redis 实例, 并且 这些实例处于 Cluster 状态. 这里, 我们会在四个节点上启动 8 个 Redis 实例.\n 启动 Redis 实例 \n 安装好 Redis 后, 在 /etc/redis/ 下会有一个 redis.conf 的默认配置文件. 我们可以修改这个配置文件. 要部署一个 Redis 集群, 我们要修改的地方如下:\nport 6379\ncluster-enabled yes\ncluster-config-file node-6379.conf\ncluster-node-timeout 5000\nprotected-mode no\n# bind 127.0.0.1\nbind MY_IP\n## or\nbind 0.0.0.0\n\n 在 Redis 源码包里有一个脚本 utils/redis_init_script, 可以比较方便地启动和关闭 Redis 服务:\nREDISPORT=6379\nEXEC=/usr/local/bin/redis-server\nCLIEXEC=/usr/local/bin/redis-cli\n\nPIDFILE=/var/run/redis_${REDISPORT}.pid\nCONF=\"/etc/redis/${REDISPORT}.conf\"\n\ncase \"$1\" in\n    start)\n        if [-f $PIDFILE]\n        then\n                echo \"$PIDFILE exists, process is already running or crashed\"\n        else\n                echo \"Starting Redis server...\"\n                $EXEC $CONF\n        fi\n        ;;\n    stop)\n        if [! -f $PIDFILE]\n        then\n                echo \"$PIDFILE does not exist, process is not running\"\n        else\n                PID=$(cat $PIDFILE)\n                echo \"Stopping ...\"\n                $CLIEXEC -p $REDISPORT shutdown\n                while [-x /proc/${PID} ]\n                do\n                    echo \"Waiting for Redis to shutdown ...\"\n                    sleep 1\n                done\n                echo \"Redis stopped\"\n        fi\n        ;;\n    *)\n        echo \"Please use start or stop as first argument\"\n        ;;\nesac\n\n 在这里, 我们在 4 个节点上的 7000 和 8000 端口各分别启动一个 redis 实例:\nIP=(192.168.60.94 192.168.60.95 192.168.60.96 192.168.60.97)\nports=(7000 8000)\n$ for ips in ${IP[*]}; do\n\tfor port in ${ports[*]}; do\n\t  ssh $ips mkdir -p /var/lib/redis/${port}\n\t  cp redis_template.conf $port.conf\n\t  cp redis_init.sh redis_$port\n\t  sed -i -e \"s/6379/$port/g\" -e \"s/MY_IP/$ips/g\" $port.conf && scp $port.conf $ips:/etc/redis/\n\t  sed -i \"s/6379/$port/g\" redis_$port && scp redis_$port $ips:/etc/init.d/\n\t  ssh $ips /etc/init.d/redis_${port} start\n\tdone\ndone\n\n 启动好 8 个实例后, 我们就可以部署一个 4 主 4 从 的 Redis 集群了.\n 创建 Redis 集群 \n 在有了 8 个正常运行的 Redis 实例后, 我们要做一些额外的事情来搭建 Redis 集群.\n当前我们的 Redis 版本是 5.0.0, 其已经自带了 cluster 命令, 可以很方便地完成这一任务:\n$ redis-cli --cluster create 192.168.60.94:7000 192.168.60.95:7000 192.168.60.96:7000 192.168.60.97:7000 192.168.60.94:8000 192.168.60.95:8000 192.168.60.96:8000 192.168.60.97:8000 --cluster-replicas 1\n\n 如果使用的是 3 or 4 版本, 我们可以使用旧的工具 redis-trib.rb 来完成:\n$ gem install redis\n$ ./redis-trib.rb create --replicas 1 192.168.60.94:7000 192.168.60.95:7000 192.168.60.96:7000 192.168.60.97:7000 192.168.60.94:8000 192.168.60.95:8000 192.168.60.96:8000 192.168.60.97:8000 \n\n--cluster-replicas 1 or --replicas 1 表示我们想要每个主 redis 实例都有一个从 redis 实例.\nRedis-cli 会建议一个 cluster 配置, 如果没问题, 输入 yes, 集群就配置完成了, Redis 实例会进入到集群模式与其他各节点进行通信. 如果一切没有问题, 最后会出现如下的信息:\n[OK] All 16384 slots covered\n\n 这意味着 16384 个 slots 中的每一个都由一个 master 服务着.\n 使用 Redis 集群 \n 查看节点系统信息 \n$ redis-cli -p 7000 info\n# Server\nredis_version:5.0.0\nredis_git_sha1:00000000\nredis_git_dirty:0\nredis_build_id:b70c7303801d62f5\nredis_mode:cluster\n...\nconfig_file:/etc/redis/7000.conf\n\n# Clients\nconnected_clients:1\nclient_recent_max_input_buffer:2\nclient_recent_max_output_buffer:0\nblocked_clients:0\n\n# Memory\nused_memory:2679024\nused_memory_human:2.55M\nused_memory_rss:9224192\nused_memory_rss_human:8.80M\n...\n\n# Persistence\nloading:0\nrdb_changes_since_last_save:0\nrdb_bgsave_in_progress:0\nrdb_last_save_time:1541496914\n...\n\n# Stats\ntotal_connections_received:22\ntotal_commands_processed:615\ninstantaneous_ops_per_sec:1\n...\n\n# Replication\nrole:master\nconnected_slaves:1\nslave0:ip=192.168.60.94,port=8000,state=online,offset=980,lag=0\nmaster_replid:7f97949f8203a2f9532edcdcbf606b48bab1e045\nmaster_replid2:b69c6ebce2c36f14eb2d35ad78892ab12813c5ba\n...\n\n# CPU\nused_cpu_sys:1.407291\nused_cpu_user:1.276415\nused_cpu_sys_children:0.001923\nused_cpu_user_children:0.000961\n\n# Cluster\ncluster_enabled:1\n\n# Keyspace\n\n 查看集群信息 \n$ redis-cli -p 7000 cluster info\ncluster_state:ok\ncluster_slots_assigned:16384\ncluster_slots_ok:16384\ncluster_slots_pfail:0\ncluster_slots_fail:0\ncluster_known_nodes:8\ncluster_size:4\ncluster_current_epoch:9\ncluster_my_epoch:9\n...\n\n 查看集群节点信息 \n$ redis-cli --cluster -p 7000 cluster nodes\n770a8abf7c80d4c0051205e4613ee273c8d9985d 192.168.60.95:8000@18000 slave 15b29ddac7bd12b5ce5f61b735b1e3d52e4b17eb 0 1541496916709 6 connected\n09020f2b4a8394975c2c0bc6f0b13720a19e1cf4 192.168.60.96:7000@17000 master - 0 1541496916508 7 connected 10240-16383\n9a8b796820f1cd81aec0271b585fa2b6d9b89fe7 192.168.60.96:8000@18000 slave c011bfaa93a3ce8fefbe07f9509909c81b57dfc3 0 1541496915000 9 connected\n15b29ddac7bd12b5ce5f61b735b1e3d52e4b17eb 192.168.60.94:7000@17000 master - 0 1541496917000 3 connected 1024-4095\nc011bfaa93a3ce8fefbe07f9509909c81b57dfc3 192.168.60.95:7000@17000 master - 0 1541496917711 5 connected 5120-8191\ncfd2797de67a700f5cdb0add60b7d4d947035a5b 192.168.60.97:8000@18000 slave 09020f2b4a8394975c2c0bc6f0b13720a19e1cf4 0 1541496916000 7 connected\n6fa54252c757c1d5f14ffd99d42d028608e41b35 192.168.60.94:8000@18000 slave 24bee81ae3fc08ba9262f4153fd56e5f1be5e795 0 1541496918712 9 connected\n24bee81ae3fc08ba9262f4153fd56e5f1be5e795 192.168.60.97:7000@17000 myself,master - 0 1541496916000 9 connected 0-1023 4096-5119 8192-10239\n\n\n        document.querySelectorAll('.github-emoji')\n          .forEach(el => {\n            if (!el.dataset.src) { return; }\n            const img = document.createElement('img');\n            img.style = 'display:none !important;';\n            img.src = el.dataset.src;\n            img.addEventListener('error', () => {\n              img.remove();\n              el.style.color = 'inherit';\n              el.style.backgroundImage = 'none';\n              el.style.background = 'none';\n            });\n            img.addEventListener('load', () => {\n              img.remove();\n            });\n            document.body.appendChild(img);\n          });\n      ","dateCreated":"2018-09-10T11:22:28+08:00","dateModified":"2020-04-13T11:20:25+08:00","datePublished":"2018-09-10T11:22:28+08:00","description":"Redis 是一个开源的、轻量级的、高性能的、基于 键-值 对的缓存与存储系统，非常适合用来缓存和存储服务和消息队列、任务队列等。","headline":"部署并运行 Redis 数据库集群","image":["redis.png"],"mainEntityOfPage":{"@type":"WebPage","@id":"https://amito.me/2018/Deploy-And-Manage-A-Redis-Cluster/"},"publisher":{"@type":"Organization","name":"Yujiang Bi","sameAs":["https://github.com/byujiang","https://twitter.com/byujiang","https://facebook.com/byujiang","https://www.linkedin.com/profile/","mailto:byujiang@gmail.com"],"image":"bio.jpg","logo":{"@type":"ImageObject","url":"bio.jpg"}},"url":"https://amito.me/2018/Deploy-And-Manage-A-Redis-Cluster/","keywords":"SQL, Redis","thumbnailUrl":"redis.png"}</script>
    <meta name="description" content="Redis 是一个开源的、轻量级的、高性能的、基于 键-值 对的缓存与存储系统，非常适合用来缓存和存储服务和消息队列、任务队列等。">
<meta name="keywords" content="SQL,Redis">
<meta property="og:type" content="blog">
<meta property="og:title" content="部署并运行 Redis 数据库集群">
<meta property="og:url" content="https://amito.me/2018/Deploy-And-Manage-A-Redis-Cluster/index.html">
<meta property="og:site_name" content="冬日の草原">
<meta property="og:description" content="Redis 是一个开源的、轻量级的、高性能的、基于 键-值 对的缓存与存储系统，非常适合用来缓存和存储服务和消息队列、任务队列等。">
<meta property="og:locale" content="zh-cn">
<meta property="og:image" content="https://amito.me/2018/Deploy-And-Manage-A-Redis-Cluster/redis-cluster.svg">
<meta property="og:updated_time" content="2020-04-13T03:20:25.718Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="部署并运行 Redis 数据库集群">
<meta name="twitter:description" content="Redis 是一个开源的、轻量级的、高性能的、基于 键-值 对的缓存与存储系统，非常适合用来缓存和存储服务和消息队列、任务队列等。">
<meta name="twitter:image" content="https://amito.me/2018/Deploy-And-Manage-A-Redis-Cluster/redis-cluster.svg">
<meta name="twitter:creator" content="@byujiang">
    
    
        
            <meta property="fb:admins" content="892874147463767"/>
        
    
    
        <meta property="og:image" content="https://amito.me/images/bio.jpg"/>
    
    
        <meta property="og:image" content="https://amito.me/2018/Deploy-And-Manage-A-Redis-Cluster/redis.png"/>
        <meta class="swiftype" name="image" data-type="enum" content="https://amito.me/2018/Deploy-And-Manage-A-Redis-Cluster/redis.png"/>
    
    
    
    <!--STYLES-->
    <link rel="stylesheet" href="/assets/css/style-yalgirpqgcg9sfpxxskbm3mqrllvyrmfuscckusel1s0dmattpp8om25rpf1.min.css">
    <!--STYLES END-->
    
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-46872566-3"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-46872566-3');
    </script>


    
    
	<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
	<script>
		(adsbygoogle = window.adsbygoogle || []).push({
			google_ad_client: "ca-pub-9943170083368654",
			enable_page_level_ads: true
		});
	</script>



    
        
    
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>

    <body>
        <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="blog">
            <!-- Define author's picture -->


    
        
            
        
    

<header id="header" data-behavior="2">
    <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
    <div class="header-title">
        <a
            class="header-title-link"
            href="/"
            aria-label=""
        >
            冬日の草原
        </a>
    </div>
    
        
            <a
                class="header-right-picture "
                href="#about"
                aria-label="打开链接: /#about"
            >
        
        
            <img class="header-picture" src="/images/bio.jpg" alt="作者的图片"/>
        
        </a>
    
</header>

            <!-- Define author's picture -->



        
    

<nav id="sidebar" data-behavior="2">
    <div class="sidebar-container">
        
            <div class="sidebar-profile">
                <a
                    href="/#about"
                    aria-label="阅读有关作者的更多信息"
                >
                    <img class="sidebar-profile-picture" src="/images/bio.jpg" alt="作者的图片"/>
                </a>
                <h4 class="sidebar-profile-name">Yujiang Bi</h4>
                
                    <h5 class="sidebar-profile-bio"><p>author.bio</p>
</h5>
                
            </div>
        
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/"
                            
                            rel="noopener"
                            title="首页"
                        >
                        <i class="sidebar-button-icon fa fa-home" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">首页</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-categories"
                            
                            rel="noopener"
                            title="分类"
                        >
                        <i class="sidebar-button-icon fa fa-bookmark" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">分类</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-tags"
                            
                            rel="noopener"
                            title="标签"
                        >
                        <i class="sidebar-button-icon fa fa-tags" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">标签</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/all-archives"
                            
                            rel="noopener"
                            title="归档"
                        >
                        <i class="sidebar-button-icon fa fa-archive" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">归档</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link open-algolia-search"
                            href="#search"
                            
                            rel="noopener"
                            title="搜索"
                        >
                        <i class="sidebar-button-icon fa fa-search" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">搜索</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="#about"
                            
                            rel="noopener"
                            title="关于"
                        >
                        <i class="sidebar-button-icon fa fa-question" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">关于</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://github.com/byujiang"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="GitHub"
                        >
                        <i class="sidebar-button-icon fab fa-github" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">GitHub</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://twitter.com/byujiang"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Twitter"
                        >
                        <i class="sidebar-button-icon fab fa-twitter" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Twitter</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://facebook.com/byujiang"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="Facebook"
                        >
                        <i class="sidebar-button-icon fab fa-facebook" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">Facebook</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.linkedin.com/profile/"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="LinkedIn"
                        >
                        <i class="sidebar-button-icon fab fa-linkedin" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">LinkedIn</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="mailto:byujiang@gmail.com"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="邮箱"
                        >
                        <i class="sidebar-button-icon fa fa-envelope" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">邮箱</span>
                    </a>
            </li>
            
        </ul>
        
            <ul class="sidebar-buttons">
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/atom.xml"
                            
                            rel="noopener"
                            title="RSS"
                        >
                        <i class="sidebar-button-icon fa fa-rss" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">RSS</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/donate"
                            
                            rel="noopener"
                            title="donate"
                        >
                        <i class="sidebar-button-icon fa fa-heart" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">donate</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="/links"
                            
                            rel="noopener"
                            title="links"
                        >
                        <i class="sidebar-button-icon fa fa-link" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">links</span>
                    </a>
            </li>
            
                <li class="sidebar-button">
                    
                        <a
                            class="sidebar-button-link "
                            href="https://www.vultr.com/?ref=6840862"
                            
                                target="_blank"
                            
                            rel="noopener"
                            title="vultr"
                        >
                        <i class="sidebar-button-icon fa fa-cloud" aria-hidden="true"></i>
                        <span class="sidebar-button-desc">vultr</span>
                    </a>
            </li>
            
        </ul>
        
    </div>
</nav>

            
            <div id="main" data-behavior="2"
                 class="
                        hasCoverMetaIn
                        ">
                
<article class="post">
    
    
        <div class="post-header main-content-wrap text-left">
    
        <h1 class="post-title">
            部署并运行 Redis 数据库集群
        </h1>
    
    
        <div class="post-meta">
    <time datetime="2018-09-10T11:22:28+08:00">
	
		    9月 10, 2018
    	
    </time>
    
        <span>发布在 </span>
        
    <a class="category-link" href="/categories/SQL/">SQL</a>


    
</div>

    
</div>

    
    <div class="post-content markdown">
        <div class="main-content-wrap">
            <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>Redis 是一个开源的、轻量级的、高性能的、基于 <code> 键 - 值 </code> 对的缓存与存储系统，非常适合用来缓存和存储服务和消息队列、任务队列等。</p>
<a id="more"></a>
<hr width="100%" color="#C0C0C0" size="2">
<h1 id="table-of-contents">目录</h1><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#安装 -Redis"><span class="toc-text"> 安装 Redis</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Redist- 集群介绍"><span class="toc-text">Redist 集群介绍 </span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis- 集群简介"><span class="toc-text">Redis 集群简介 </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis- 集群所用 -TCP- 端口"><span class="toc-text">Redis 集群所用 TCP 端口 </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis- 集群的主－从模型"><span class="toc-text">Redis 集群的主－从模型 </span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署 -Redis- 集群"><span class="toc-text"> 部署 Redis 集群 </span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#启动 -Redis- 实例"><span class="toc-text"> 启动 Redis 实例 </span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建 -Redis- 集群"><span class="toc-text"> 创建 Redis 集群 </span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用 -Redis- 集群"><span class="toc-text"> 使用 Redis 集群 </span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#查看节点系统信息"><span class="toc-text"> 查看节点系统信息 </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查看集群信息"><span class="toc-text"> 查看集群信息 </span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#查看集群节点信息"><span class="toc-text"> 查看集群节点信息 </span></a></li></ol></li></ol></li></ol>
<div class="figure center" style="width:;"><img class="fig-img" src="redis-cluster.svg" alt=""></div>
<h2 id="安装 -Redis"> 安装 Redis</h2>
<p> 目前最新的稳定版是 <a href="http://download.redis.io/releases/redis-5.0.0.tar.gz" target="_blank" rel="noopener">5.0.0</a>. CentOS 7 的源中最新版为 <code>3.2.12</code>. 如果不需要新特性, 可以使用官方的版本. 这里我们使用 5.0.0 版本.</p>
<pre class=" language-language-bash"><code class="language-language-bash">$ wget http://download.redis.io/releases/redis-5.0.0.tar.gz
$ tar xf redis-5.0.0.tar.gz
$ cd redis-5.0.0 && make -j4
$ make test && sudo make install
</code></pre>
<h2 id="Redist- 集群介绍">Redist 集群介绍 </h2>
<h3 id="Redis- 集群简介">Redis 集群简介 </h3>
<h3 id="Redis- 集群所用 -TCP- 端口">Redis 集群所用 TCP 端口 </h3>
<p> 每一 Redis 集群节点都要两个 TCP 连接。 一个 TCP 端口为数据端口，用于服务客户端， 默认为 <code>6379</code>， 一个为 数据端口 <code>+10000</code>, 用于集群节点间的通信，默认就是 <code>16379</code>， 增量 <code>10000</code> 是固定的。</p>
<p> 第二个端口是专门用来节点间通信的集群总结 (Cluster bus)，使用一个二进制协议。 Cluster bus 被用来作错误检测，配置更新，故障转移论证等等， 因此客户端应该永远不要使用这一端口，而是使用正常的数据端口。</p>
<p> 如果开了防火墙， 需要在防火墙中打开这两个端口， 否则 Redis 集群无法正常工作。</p>
<h3 id="Redis- 集群的主－从模型">Redis 集群的主－从模型 </h3>
<h2 id="部署 -Redis- 集群"> 部署 Redis 集群 </h2>
<p> 要部署 Redis 集群, 我们需要先有已经运行的 Redis 实例, 并且 这些实例处于 Cluster 状态. 这里, 我们会在四个节点上启动 8 个 Redis 实例.</p>
<h3 id="启动 -Redis- 实例"> 启动 Redis 实例 </h3>
<p> 安装好 Redis 后, 在 <code>/etc/redis/</code> 下会有一个 <code>redis.conf</code> 的默认配置文件. 我们可以修改这个配置文件. 要部署一个 Redis 集群, 我们要修改的地方如下:</p>
<pre class=" language-language-bash"><code class="language-language-bash">port 6379
cluster-enabled yes
cluster-config-file node-6379.conf
cluster-node-timeout 5000
protected-mode no
# bind 127.0.0.1
bind MY_IP
## or
bind 0.0.0.0
</code></pre>
<p> 在 Redis 源码包里有一个脚本 <code>utils/redis_init_script</code>, 可以比较方便地启动和关闭 Redis 服务:</p>
<pre class=" language-language-bash"><code class="language-language-bash">REDISPORT=6379
EXEC=/usr/local/bin/redis-server
CLIEXEC=/usr/local/bin/redis-cli

PIDFILE=/var/run/redis_${REDISPORT}.pid
CONF="/etc/redis/${REDISPORT}.conf"

case "$1" in
    start)
        if [-f $PIDFILE]
        then
                echo "$PIDFILE exists, process is already running or crashed"
        else
                echo "Starting Redis server..."
                $EXEC $CONF
        fi
        ;;
    stop)
        if [! -f $PIDFILE]
        then
                echo "$PIDFILE does not exist, process is not running"
        else
                PID=$(cat $PIDFILE)
                echo "Stopping ..."
                $CLIEXEC -p $REDISPORT shutdown
                while [-x /proc/${PID} ]
                do
                    echo "Waiting for Redis to shutdown ..."
                    sleep 1
                done
                echo "Redis stopped"
        fi
        ;;
    *)
        echo "Please use start or stop as first argument"
        ;;
esac
</code></pre>
<p> 在这里, 我们在 4 个节点上的 <code>7000</code> 和 <code>8000</code> 端口各分别启动一个 redis 实例:</p>
<pre class=" language-language-bash"><code class="language-language-bash">IP=(192.168.60.94 192.168.60.95 192.168.60.96 192.168.60.97)
ports=(7000 8000)
$ for ips in ${IP[*]}; do
	for port in ${ports[*]}; do
	  ssh $ips mkdir -p /var/lib/redis/${port}
	  cp redis_template.conf $port.conf
	  cp redis_init.sh redis_$port
	  sed -i -e "s/6379/$port/g" -e "s/MY_IP/$ips/g" $port.conf && scp $port.conf $ips:/etc/redis/
	  sed -i "s/6379/$port/g" redis_$port && scp redis_$port $ips:/etc/init.d/
	  ssh $ips /etc/init.d/redis_${port} start
	done
done
</code></pre>
<p> 启动好 8 个实例后, 我们就可以部署一个 4 主 4 从 的 Redis 集群了.</p>
<h3 id="创建 -Redis- 集群"> 创建 Redis 集群 </h3>
<p> 在有了 8 个正常运行的 Redis 实例后, 我们要做一些额外的事情来搭建 Redis 集群.<br>
当前我们的 Redis 版本是 5.0.0, 其已经自带了 cluster 命令, 可以很方便地完成这一任务:</p>
<pre class=" language-language-bash"><code class="language-language-bash">$ redis-cli --cluster create 192.168.60.94:7000 192.168.60.95:7000 192.168.60.96:7000 192.168.60.97:7000 192.168.60.94:8000 192.168.60.95:8000 192.168.60.96:8000 192.168.60.97:8000 --cluster-replicas 1
</code></pre>
<p> 如果使用的是 3 or 4 版本, 我们可以使用旧的工具 <code>redis-trib.rb</code> 来完成:</p>
<pre class=" language-language-bash"><code class="language-language-bash">$ gem install redis
$ ./redis-trib.rb create --replicas 1 192.168.60.94:7000 192.168.60.95:7000 192.168.60.96:7000 192.168.60.97:7000 192.168.60.94:8000 192.168.60.95:8000 192.168.60.96:8000 192.168.60.97:8000 
</code></pre>
<p><code>--cluster-replicas 1</code> or <code>--replicas 1</code> 表示我们想要每个主 redis 实例都有一个从 redis 实例.</p>
<p>Redis-cli 会建议一个 cluster 配置, 如果没问题, 输入 <code>yes</code>, 集群就配置完成了, Redis 实例会进入到集群模式与其他各节点进行通信. 如果一切没有问题, 最后会出现如下的信息:</p>
<pre class=" language-language-bash"><code class="language-language-bash">[OK] All 16384 slots covered
</code></pre>
<p> 这意味着 16384 个 slots 中的每一个都由一个 master 服务着.</p>
<h2 id="使用 -Redis- 集群"> 使用 Redis 集群 </h2>
<h4 id="查看节点系统信息"> 查看节点系统信息 </h4>
<pre class=" language-language-bash"><code class="language-language-bash">$ redis-cli -p 7000 info
# Server
redis_version:5.0.0
redis_git_sha1:00000000
redis_git_dirty:0
redis_build_id:b70c7303801d62f5
redis_mode:cluster
...
config_file:/etc/redis/7000.conf

# Clients
connected_clients:1
client_recent_max_input_buffer:2
client_recent_max_output_buffer:0
blocked_clients:0

# Memory
used_memory:2679024
used_memory_human:2.55M
used_memory_rss:9224192
used_memory_rss_human:8.80M
...

# Persistence
loading:0
rdb_changes_since_last_save:0
rdb_bgsave_in_progress:0
rdb_last_save_time:1541496914
...

# Stats
total_connections_received:22
total_commands_processed:615
instantaneous_ops_per_sec:1
...

# Replication
role:master
connected_slaves:1
slave0:ip=192.168.60.94,port=8000,state=online,offset=980,lag=0
master_replid:7f97949f8203a2f9532edcdcbf606b48bab1e045
master_replid2:b69c6ebce2c36f14eb2d35ad78892ab12813c5ba
...

# CPU
used_cpu_sys:1.407291
used_cpu_user:1.276415
used_cpu_sys_children:0.001923
used_cpu_user_children:0.000961

# Cluster
cluster_enabled:1

# Keyspace
</code></pre>
<h4 id="查看集群信息"> 查看集群信息 </h4>
<pre class=" language-language-bash"><code class="language-language-bash">$ redis-cli -p 7000 cluster info
cluster_state:ok
cluster_slots_assigned:16384
cluster_slots_ok:16384
cluster_slots_pfail:0
cluster_slots_fail:0
cluster_known_nodes:8
cluster_size:4
cluster_current_epoch:9
cluster_my_epoch:9
...
</code></pre>
<h4 id="查看集群节点信息"> 查看集群节点信息 </h4>
<pre class=" language-language-bash"><code class="language-language-bash">$ redis-cli --cluster -p 7000 cluster nodes
770a8abf7c80d4c0051205e4613ee273c8d9985d 192.168.60.95:8000@18000 slave 15b29ddac7bd12b5ce5f61b735b1e3d52e4b17eb 0 1541496916709 6 connected
09020f2b4a8394975c2c0bc6f0b13720a19e1cf4 192.168.60.96:7000@17000 master - 0 1541496916508 7 connected 10240-16383
9a8b796820f1cd81aec0271b585fa2b6d9b89fe7 192.168.60.96:8000@18000 slave c011bfaa93a3ce8fefbe07f9509909c81b57dfc3 0 1541496915000 9 connected
15b29ddac7bd12b5ce5f61b735b1e3d52e4b17eb 192.168.60.94:7000@17000 master - 0 1541496917000 3 connected 1024-4095
c011bfaa93a3ce8fefbe07f9509909c81b57dfc3 192.168.60.95:7000@17000 master - 0 1541496917711 5 connected 5120-8191
cfd2797de67a700f5cdb0add60b7d4d947035a5b 192.168.60.97:8000@18000 slave 09020f2b4a8394975c2c0bc6f0b13720a19e1cf4 0 1541496916000 7 connected
6fa54252c757c1d5f14ffd99d42d028608e41b35 192.168.60.94:8000@18000 slave 24bee81ae3fc08ba9262f4153fd56e5f1be5e795 0 1541496918712 9 connected
24bee81ae3fc08ba9262f4153fd56e5f1be5e795 192.168.60.97:7000@17000 myself,master - 0 1541496916000 9 connected 0-1023 4096-5119 8192-10239
</code></pre>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script>
            


            <div class="post_reward" style="margin-top:15px;margin-bottom:0px;">
	<label class="reward_btn">Buy Me A Coffee?</label>
	<div class="qr_code">
		<div class="qr_code_img">
			<img class="image" src="/images/wechat.png" style="width:80%;" title="WeChat">
		</div>
		<div class="qr_code_img">
			<img class="image" src="/images/alipay.png" style="width:80%;" title="AliPay">
		</div>
		<div class="qr_code_img">
			<img class="image" src="/images/paypal.png" style="width:80%;" title="PayPal">
		</div>
	</div>
	<hr noshade style="color:rgba(252, 244, 244, 0.952); margin-top:10px;" />
</div>

        </div>
    </div>
    <div id="post-footer" class="post-footer main-content-wrap">
        
            <div class="post-footer-tags">
                <span class="text-color-light text-small">标签</span><br/>
                
    <a class="tag tag--primary tag--small t-link" href="/tags/Redis/">Redis</a> <a class="tag tag--primary tag--small t-link" href="/tags/SQL/">SQL</a>

            </div>
        
        
            <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2018/Backup-and-Restore-in-QuarkDB-Cluster/"
                    data-tooltip="QuarkDB 集群数据库的备份与恢复"
                    aria-label="上一篇: QuarkDB 集群数据库的备份与恢复"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2018/Deploy-And-Run-A-QuarkDB-Cluster/"
                    data-tooltip="搭建并运行管理 QuarkDB 集群"
                    aria-label="下一篇: 搭建并运行管理 QuarkDB 集群"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Diesen Beitrag teilen"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://amito.me/2018/Deploy-And-Manage-A-Redis-Cluster/"
                    title="分享到 Facebook"
                    aria-label="分享到 Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://amito.me/2018/Deploy-And-Manage-A-Redis-Cluster/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://amito.me/2018/Deploy-And-Manage-A-Redis-Cluster/"
                    title="global.share_on_linkedin"
                    aria-label="global.share_on_linkedin"
                >
                    <i class="fab fa-linkedin" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://amito.me/2018/Deploy-And-Manage-A-Redis-Cluster/"
                    title="分享到 Weibo"
                    aria-label="分享到 Weibo"
                >
                    <i class="fab fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a
                        class="post-action-btn btn btn--default"
                        href="#disqus_thread"
                        aria-label="Kommentieren"
                    >
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#table-of-contents" aria-label="目录">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


        
        
            
                <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
            
        
    </div>
</article>



                <footer id="footer" class="main-content-wrap">
    <span class="copyrights">
        Copyrights &copy; 2020 Yujiang Bi. All Rights Reserved.
    </span>
</footer>

            </div>
            
                <div id="bottom-bar" class="post-bottom-bar" data-behavior="2">
                    <div class="post-actions-wrap">
    <nav>
        <ul class="post-actions post-action-nav">
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2018/Backup-and-Restore-in-QuarkDB-Cluster/"
                    data-tooltip="QuarkDB 集群数据库的备份与恢复"
                    aria-label="上一篇: QuarkDB 集群数据库的备份与恢复"
                >
                    
                        <i class="fa fa-angle-left" aria-hidden="true"></i>
                        <span class="hide-xs hide-sm text-small icon-ml">上一篇</span>
                    </a>
            </li>
            <li class="post-action">
                
                    
                <a
                    class="post-action-btn btn btn--default tooltip--top"
                    href="/2018/Deploy-And-Run-A-QuarkDB-Cluster/"
                    data-tooltip="搭建并运行管理 QuarkDB 集群"
                    aria-label="下一篇: 搭建并运行管理 QuarkDB 集群"
                >
                    
                        <span class="hide-xs hide-sm text-small icon-mr">下一篇</span>
                        <i class="fa fa-angle-right" aria-hidden="true"></i>
                    </a>
            </li>
        </ul>
    </nav>
    <ul class="post-actions post-action-share">
        <li class="post-action hide-lg hide-md hide-sm">
            <a
                class="post-action-btn btn btn--default btn-open-shareoptions"
                href="#btn-open-shareoptions"
                aria-label="Diesen Beitrag teilen"
            >
                <i class="fa fa-share-alt" aria-hidden="true"></i>
            </a>
        </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.facebook.com/sharer/sharer.php?u=https://amito.me/2018/Deploy-And-Manage-A-Redis-Cluster/"
                    title="分享到 Facebook"
                    aria-label="分享到 Facebook"
                >
                    <i class="fab fa-facebook" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://twitter.com/intent/tweet?text=https://amito.me/2018/Deploy-And-Manage-A-Redis-Cluster/"
                    title="分享到 Twitter"
                    aria-label="分享到 Twitter"
                >
                    <i class="fab fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://amito.me/2018/Deploy-And-Manage-A-Redis-Cluster/"
                    title="global.share_on_linkedin"
                    aria-label="global.share_on_linkedin"
                >
                    <i class="fab fa-linkedin" aria-hidden="true"></i>
                </a>
            </li>
        
            
            
            <li class="post-action hide-xs">
                <a
                    class="post-action-btn btn btn--default"
                    target="new" href="http://service.weibo.com/share/share.php?&amp;title=https://amito.me/2018/Deploy-And-Manage-A-Redis-Cluster/"
                    title="分享到 Weibo"
                    aria-label="分享到 Weibo"
                >
                    <i class="fab fa-weibo" aria-hidden="true"></i>
                </a>
            </li>
        
        
            
                <li class="post-action">
                    <a
                        class="post-action-btn btn btn--default"
                        href="#disqus_thread"
                        aria-label="Kommentieren"
                    >
                        <i class="fa fa-comment"></i>
                    </a>
                </li>
            
        
        <li class="post-action">
            
                <a class="post-action-btn btn btn--default" href="#table-of-contents" aria-label="目录">
            
                <i class="fa fa-list" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>


                </div>
                
    <div id="share-options-bar" class="share-options-bar" data-behavior="2">
        <i id="btn-close-shareoptions" class="fa fa-times"></i>
        <ul class="share-options">
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.facebook.com/sharer/sharer.php?u=https://amito.me/2018/Deploy-And-Manage-A-Redis-Cluster/"
                        aria-label="分享到 Facebook"
                    >
                        <i class="fab fa-facebook" aria-hidden="true"></i><span>分享到 Facebook</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://twitter.com/intent/tweet?text=https://amito.me/2018/Deploy-And-Manage-A-Redis-Cluster/"
                        aria-label="分享到 Twitter"
                    >
                        <i class="fab fa-twitter" aria-hidden="true"></i><span>分享到 Twitter</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://amito.me/2018/Deploy-And-Manage-A-Redis-Cluster/"
                        aria-label="global.share_on_linkedin"
                    >
                        <i class="fab fa-linkedin" aria-hidden="true"></i><span>global.share_on_linkedin</span>
                    </a>
                </li>
            
                
                
                <li class="share-option">
                    <a
                        class="share-option-btn"
                        target="new"
                        href="http://service.weibo.com/share/share.php?&amp;title=https://amito.me/2018/Deploy-And-Manage-A-Redis-Cluster/"
                        aria-label="分享到 Weibo"
                    >
                        <i class="fab fa-weibo" aria-hidden="true"></i><span>分享到 Weibo</span>
                    </a>
                </li>
            
        </ul>
    </div>


            
        </div>
        


    
        
    

<div id="about">
    <div id="about-card">
        <div id="about-btn-close">
            <i class="fa fa-times"></i>
        </div>
        
            <img id="about-card-picture" src="/images/bio.jpg" alt="作者的图片"/>
        
            <h4 id="about-card-name">Yujiang Bi</h4>
        
            <div id="about-card-bio"><p>author.bio</p>
</div>
        
        
            <div id="about-card-job">
                <i class="fa fa-briefcase"></i>
                <br/>
                <p>author.job</p>

            </div>
        
        
            <div id="about-card-location">
                <i class="fa fa-map-marker-alt"></i>
                <br/>
                Beijing, China
            </div>
        
    </div>
</div>

        
        
<div id="cover" style="background-image:url('/images/cover.jpg');"></div>
        <!--SCRIPTS-->
<script src="/assets/js/script-lwx5xgjnm88yasbplcvsgt04dcgdoesyxbq14mbwldmkbsqdt76ewmiqlzam.min.js"></script>
<!--SCRIPTS END-->


    
        <script>
          var disqus_config = function() {
            this.page.url = 'https://amito.me/2018/Deploy-And-Manage-A-Redis-Cluster/';
              
            this.page.identifier = '2018/Deploy-And-Manage-A-Redis-Cluster/';
              
          };
          (function() {
            var d = document, s = d.createElement('script');
            var disqus_shortname = 'amito';
            s.src = '//' + disqus_shortname + '.disqus.com/embed.js';

            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
          })();
        </script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({"tex2jax":{"inlineMath":[["$","$"],["\\(","\\)"]],"skipTags":["script","noscript","style","textarea","pre","code"],"processEscapes":true},"TeX":{"equationNumbers":{"autoNumber":"AMS"}}});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
    




    </body>
</html>
